<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fitness App | Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_FIREBASE_API_KEY",
  authDomain: "fitnessapp-9e628.firebaseapp.com",
  projectId: "fitnessapp-9e628",
  storageBucket: "fitnessapp-9e628.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- CONSTANTS ---------- */
const GOAL_TIME = 1800; // 30 min
const CIRCUM = 283;

/* Calories per minute by goal */
const CAL_RATE = {
  weight_loss: 8,
  muscle_gain: 6,
  endurance: 7
};

/* ---------- STATE ---------- */
let userData = {};
let activeWorkout = null;
let seconds = 0;
let calories = 0;
let interval = null;
let paused = false;

/* ---------- HELPERS ---------- */
const today = (d = new Date()) => d.toISOString().split("T")[0];

function setProgress(id, sec) {
  const percent = Math.min(sec / GOAL_TIME, 1);
  document.getElementById(id).style.strokeDashoffset =
    CIRCUM - percent * CIRCUM;
}

function show(section) {
  ["dashboard", "workout", "workoutPlans"].forEach(id =>
    document.getElementById(id).style.display = "none"
  );
  document.getElementById(section).style.display = "block";
}

/* ---------- WORKOUT ---------- */
window.startWorkout = type => {
  activeWorkout = type;
  seconds = 0;
  calories = 0;
  paused = false;

  document.getElementById("wName").innerText = type.toUpperCase();
  document.getElementById("timer").innerText = "00:00";
  document.getElementById("cal").innerText = "0";
  document.getElementById("pauseBtn").innerText = "Pause";

  show("workout");

  /* ---------- WORKOUT PLANS ---------- */
window.showWorkoutPlans = () => {
  show("workoutPlans");
};

window.selectWorkoutPlan = async (planType) => {
  const user = auth.currentUser;
  const userRef = doc(db, "users", user.uid);
  
  await setDoc(userRef, {
    selectedPlan: planType,
    planStartDate: today()
  }, { merge: true });
  
  show("dashboard");
  loadDashboard(user);
};

window.viewPlanDetails = (planFile) => {
  window.open(planFile, '_blank');
};

  interval = setInterval(() => {
    if (!paused) {
      seconds++;
      calories += CAL_RATE[userData.goal] / 60;

      document.getElementById("timer").innerText =
        `${Math.floor(seconds/60)}:${(seconds%60).toString().padStart(2,"0")}`;
      document.getElementById("cal").innerText = calories.toFixed(1);
    }
  }, 1000);
};

window.togglePause = () => {
  paused = !paused;
  document.getElementById("pauseBtn").innerText =
    paused ? "Resume" : "Pause";
};

window.finishWorkout = async () => {
  clearInterval(interval);
  const user = auth.currentUser;
  const ref = doc(db, "users", user.uid, "workouts", today());
  const snap = await getDoc(ref);
  const prev = snap.exists() ? snap.data() : {};

  const creditsEarned = Math.floor(seconds / 30);

await setDoc(ref, {
  [activeWorkout]: (prev[activeWorkout] || 0) + seconds,
  calories: (prev.calories || 0) + Math.round(calories),
  creditsEarned: (prev.creditsEarned || 0) + creditsEarned
}, { merge: true });

// Update total user credits
await setDoc(doc(db, "users", user.uid), {
  credits: (userData.credits || 0) + creditsEarned
}, { merge: true });


  show("dashboard");
  loadDashboard(user);
};

/* ---------- DASHBOARD ---------- */
async function loadDashboard(user) {
  
  /* user info */
  const uSnap = await getDoc(doc(db, "users", user.uid));
  userData = uSnap.data();
  document.getElementById("goal").innerText = userData.goal.replace("_", " ");
  document.getElementById("credits").innerText = userData.credits || 0;

  // Ensure credits field exists
if (userData.credits === undefined) {
  await setDoc(doc(db, "users", user.uid), {
    credits: 0
  }, { merge: true });

  userData.credits = 0;
}

  // Display selected workout plan
  if (userData.selectedPlan) {
    document.getElementById("currentPlan").innerText = userData.selectedPlan.toUpperCase();
  } else {
    document.getElementById("currentPlan").innerText = "None selected";
  }

  /* today progress */
  const tSnap = await getDoc(doc(db, "users", user.uid, "workouts", today()));
  const data = tSnap.exists() ? tSnap.data() : {};

  setProgress("runP", data.running || 0);
  setProgress("pushP", data.pushups || 0);
  setProgress("yogaP", data.yoga || 0);
  document.getElementById("todayCal").innerText = data.calories || 0;

  /* weekly history */
  let history = "";
  for (let i = 0; i < 7; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const snap = await getDoc(
      doc(db, "users", user.uid, "workouts", today(d))
    );
    if (snap.exists()) {
      const v = snap.data();
      history += `${today(d)} â†’ â± ${Object.values(v)
        .filter(x => typeof x === "number")
        .reduce((a,b)=>a+b,0)} sec | ğŸ”¥ ${v.calories || 0} cal\n`;
    }
  }
  document.getElementById("history").innerText = history || "No data yet";
}

/* ---------- AUTH ---------- */
onAuthStateChanged(auth, user => {
  if (!user) window.location.href = "sign.html";
  else loadDashboard(user);
});

window.logout = async () => {
  await signOut(auth);
  window.location.href = "sign.html";
};



</script>

<style>
body { margin:0;font-family:Arial;background:#0f2027;color:white }
.header{background:#1e1e1e;padding:15px;display:flex;justify-content:space-between;align-items:center}
.card{background:#1e1e1e;margin:15px;padding:20px;border-radius:12px}
.exercise-grid{display:flex;gap:20px;flex-wrap:wrap}
.exercise{text-align:center;cursor:pointer}
circle{fill:none;stroke-width:8}
.bg{stroke:#333}
.progress{stroke:#ff7a18;stroke-dasharray:283;stroke-dashoffset:283;
transform:rotate(-90deg);transform-origin:50% 50%}
#workout, #workoutPlans{display:none;text-align:center;padding-top:40px}
.plan-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;padding:20px}
.plan-card{background:#2a2a2a;padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s}
.plan-card:hover{border-color:#ff7a18;transform:translateY(-5px)}
.plan-card h3{color:#ff7a18;margin-top:0}
button{background:#ff7a18;border:none;padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer;color:white;margin:5px}
button:hover{background:#ff8c3a}
pre{white-space:pre-line}
</style>
</head>

<body>

<div class="header">
  <h3>Fitness Dashboard</h3>
  <div>
    <button onclick="showWorkoutPlans()">Workout Plans</button>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<div id="dashboard">
  <div class="card">
  <h3>Goal: <span id="goal"></span></h3>
  <p>ğŸ”¥ Calories Today: <strong id="todayCal">0</strong></p>
  <p>â­ Credits: <strong id="credits">0</strong></p>
  <p>ğŸ“‹ Current Plan: <strong id="currentPlan">None</strong></p>
</div>

  <div class="card">
  <h3>Goal: <span id="goal"></span></h3>
  <p>ğŸ”¥ Calories Today: <strong id="todayCal">0</strong></p>
  <p>ğŸ“‹ Current Plan: <strong id="currentPlan">None</strong></p>
</div>

  <div class="card">
    <h3>Today's Workouts</h3>
    <div class="exercise-grid">

      <div class="exercise" onclick="startWorkout('running')">
        <svg width="100" height="100">
          <circle class="bg" cx="50" cy="50" r="45"/>
          <circle class="progress" id="runP" cx="50" cy="50" r="45"/>
        </svg><p>ğŸƒ Running</p>
      </div>

      <div class="exercise" onclick="startWorkout('pushups')">
        <svg width="100" height="100">
          <circle class="bg" cx="50" cy="50" r="45"/>
          <circle class="progress" id="pushP" cx="50" cy="50" r="45"/>
        </svg><p>ğŸ’ª Pushups</p>
      </div>

      <div class="exercise" onclick="startWorkout('yoga')">
        <svg width="100" height="100">
          <circle class="bg" cx="50" cy="50" r="45"/>
          <circle class="progress" id="yogaP" cx="50" cy="50" r="45"/>
        </svg><p>ğŸ§˜ Yoga</p>
      </div>

    </div>
  </div>

  <div class="card">
    <h3>Weekly History</h3>
    <pre id="history"></pre>
  </div>

</div>

<div id="workout">
  <h2 id="wName"></h2>
  <h1 id="timer">00:00</h1>
  <h3>ğŸ”¥ Calories: <span id="cal">0</span></h3>
  <button id="pauseBtn" onclick="togglePause()">Pause</button>
  <br><br>
  <button onclick="finishWorkout()">Finish Workout</button>
</div>

<div id="workoutPlans">
  <h2>Choose Your Workout Plan</h2>
  <div class="plan-grid">
    
    <div class="plan-card" onclick="selectWorkoutPlan('beginner')">
      <h3>ğŸŒ± Beginner Plan</h3>
      <p>Perfect for getting started with fitness</p>
      <p><strong>Duration:</strong> 4 weeks</p>
      <button onclick="event.stopPropagation(); viewPlanDetails('beginner-plan.html')">View Details</button>
    </div>

    <div class="plan-card" onclick="selectWorkoutPlan('intermediate')">
      <h3>ğŸ’ª Intermediate Plan</h3>
      <p>Build strength and endurance</p>
      <p><strong>Duration:</strong> 6 weeks</p>
      <button onclick="event.stopPropagation(); viewPlanDetails('intermediate-plan.html')">View Details</button>
    </div>

    <div class="plan-card" onclick="selectWorkoutPlan('advanced')">
      <h3>ğŸ”¥ Advanced Plan</h3>
      <p>High-intensity training program</p>
      <p><strong>Duration:</strong> 8 weeks</p>
      <button onclick="event.stopPropagation(); viewPlanDetails('advanced-plan.html')">View Details</button>
    </div>

  </div>
  <button onclick="show('dashboard')">Back to Dashboard</button>
</div>

</body>
</html>

